name: Analyze PR Impact on E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout poc-front-app
        uses: actions/checkout@v4
        with:
          path: poc-front-app

      - name: Checkout poc-e2e-tests
        uses: actions/checkout@v4
        with:
          repository: devedux/poc-e2e-tests
          path: poc-e2e-tests

      - name: Checkout poc-analyzer
        uses: actions/checkout@v4
        with:
          repository: devedux/poc-analyzer
          path: poc-analyzer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: poc-analyzer/package-lock.json

      - name: Install poc-analyzer dependencies
        working-directory: poc-analyzer
        run: npm ci

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama
        run: ollama serve &

      - name: Wait for Ollama to be ready
        run: |
          for i in {1..10}; do
            curl -s http://localhost:11434 && break || sleep 3
          done

      - name: Pull llama3.2
        run: ollama pull llama3.2

      - name: Run PR analysis
        working-directory: poc-analyzer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: devedux
          GITHUB_REPO: poc-front-app
          E2E_REPO_PATH: ${{ github.workspace }}/poc-e2e-tests
        run: npm run analyze:pr ${{ github.event.pull_request.number }}
